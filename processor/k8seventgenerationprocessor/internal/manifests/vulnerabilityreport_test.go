// Copyright 2025 SolarWinds Worldwide, LLC. All rights reserved.
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//     http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

package manifests

import (
	"os"
	"testing"

	"github.com/stretchr/testify/assert"
	"github.com/stretchr/testify/require"
)

func TestParseVulnerabilityReportManifest(t *testing.T) {
	jsonBytes, err := os.ReadFile("testdata/vulnerability_report.json")
	require.NoError(t, err)

	manifest, err := ParseVulnerabilityReportManifest(jsonBytes)
	require.NoError(t, err)
	require.NotNil(t, manifest)

	assert.Equal(t, "aquasecurity.github.io/v1alpha1", manifest.ApiVersion)
	assert.Equal(t, "VulnerabilityReport", manifest.Kind)
	assert.Equal(t, "daemonset-kube-proxy-kube-proxy", manifest.Metadata.Name)
	assert.Equal(t, "kube-system", manifest.Metadata.Namespace)
	assert.Equal(t, "91bb71e5-ef8e-48a3-beb3-70f4edb4c475", manifest.Metadata.Uid)

	assert.Equal(t, "DaemonSet", manifest.Metadata.Labels["trivy-operator.resource.kind"])
	assert.Equal(t, "kube-proxy", manifest.Metadata.Labels["trivy-operator.resource.name"])
	assert.Equal(t, "kube-system", manifest.Metadata.Labels["trivy-operator.resource.namespace"])

	assert.Equal(t, "sha256:83c025f0faa6799fab6645102a98138e39a9a7db2be3bc792c79d72659b1805d", manifest.Report.Artifact.Digest)
	assert.Equal(t, "registry.k8s.io", manifest.Report.Registry.Server)
	assert.Equal(t, "kube-proxy", manifest.Report.Artifact.Repository)
	assert.Equal(t, "Trivy", manifest.Report.Scanner.Name)

	require.Len(t, manifest.Report.Vulnerabilities, 1)
	vuln := manifest.Report.Vulnerabilities[0]
	assert.Equal(t, "CVE-2016-2781", vuln.VulnerabilityID)
	assert.Equal(t, "LOW", vuln.Severity)
	assert.Equal(t, 6.5, vuln.Score)
	assert.Equal(t, "coreutils", vuln.Resource)
	assert.Equal(t, "9.1-1", vuln.InstalledVersion)
	assert.Equal(t, "coreutils: Non-privileged session can escape to the parent session in chroot", vuln.Title)
	assert.Equal(t, "https://avd.aquasec.com/nvd/cve-2016-2781", vuln.PrimaryLink)
}

func TestParseVulnerabilityReportManifest_FullReport(t *testing.T) {
	jsonBytes, err := os.ReadFile("../../../../body.json")
	require.NoError(t, err)

	manifest, err := ParseVulnerabilityReportManifest(jsonBytes)
	require.NoError(t, err)
	require.NotNil(t, manifest)

	assert.Equal(t, "aquasecurity.github.io/v1alpha1", manifest.ApiVersion)
	assert.Equal(t, "VulnerabilityReport", manifest.Kind)

	assert.Equal(t, "daemonset-kube-proxy-kube-proxy", manifest.Metadata.Name)
	assert.Equal(t, "kube-system", manifest.Metadata.Namespace)
	assert.Equal(t, "91bb71e5-ef8e-48a3-beb3-70f4edb4c475", manifest.Metadata.Uid)
	assert.Equal(t, "2025-12-08T08:09:57Z", manifest.Metadata.CreationTimestamp)

	assert.Equal(t, "DaemonSet", manifest.Metadata.Labels["trivy-operator.resource.kind"])
	assert.Equal(t, "kube-proxy", manifest.Metadata.Labels["trivy-operator.resource.name"])
	assert.Equal(t, "kube-system", manifest.Metadata.Labels["trivy-operator.resource.namespace"])
	assert.Equal(t, "kube-proxy", manifest.Metadata.Labels["trivy-operator.container.name"])

	assert.Equal(t, "24h0m0s", manifest.Metadata.Annotations["trivy-operator.aquasecurity.github.io/report-ttl"])

	assert.Equal(t, "sha256:83c025f0faa6799fab6645102a98138e39a9a7db2be3bc792c79d72659b1805d", manifest.Report.Artifact.Digest)
	assert.Equal(t, "kube-proxy", manifest.Report.Artifact.Repository)
	assert.Equal(t, "v1.32.2", manifest.Report.Artifact.Tag)

	assert.Equal(t, "Trivy", manifest.Report.Scanner.Name)
	assert.Equal(t, "Aqua Security", manifest.Report.Scanner.Vendor)
	assert.Equal(t, "0.66.0", manifest.Report.Scanner.Version)

	assert.Equal(t, "2025-12-08T08:09:57Z", manifest.Report.UpdateTimestamp)

	require.GreaterOrEqual(t, len(manifest.Report.Vulnerabilities), 2)

	vuln1 := manifest.Report.Vulnerabilities[0]
	assert.Equal(t, "CVE-2016-2781", vuln1.VulnerabilityID)
	assert.Equal(t, "LOW", vuln1.Severity)
	assert.Equal(t, 6.5, vuln1.Score)
	assert.Equal(t, "coreutils", vuln1.Resource)
	assert.Equal(t, "9.1-1", vuln1.InstalledVersion)
	assert.Equal(t, "", vuln1.FixedVersion)
	assert.Equal(t, "coreutils: Non-privileged session can escape to the parent session in chroot", vuln1.Title)
	assert.Equal(t, "https://avd.aquasec.com/nvd/cve-2016-2781", vuln1.PrimaryLink)
	assert.Equal(t, "pkg:deb/debian/coreutils@9.1-1?arch=amd64&distro=debian-12.9", vuln1.PackagePURL)

	vuln2 := manifest.Report.Vulnerabilities[1]
	assert.Equal(t, "CVE-2017-18018", vuln2.VulnerabilityID)
	assert.Equal(t, "LOW", vuln2.Severity)
	assert.Equal(t, 4.7, vuln2.Score)
	assert.Equal(t, "coreutils: race condition vulnerability in chown and chgrp", vuln2.Title)
}
