// Copyright 2025 SolarWinds Worldwide, LLC. All rights reserved.
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//     http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

package manifests

import "encoding/json"

type VulnerabilityReportManifest struct {
	ApiVersion string                      `json:"apiVersion"`
	Kind       string                      `json:"kind"`
	Metadata   VulnerabilityReportMetadata `json:"metadata"`
	Report     VulnerabilityReportReport   `json:"report"`
}

type VulnerabilityReportMetadata struct {
	Name              string            `json:"name"`
	Namespace         string            `json:"namespace"`
	Uid               string            `json:"uid"`
	Labels            map[string]string `json:"labels"`
	CreationTimestamp string            `json:"creationTimestamp"`
	Annotations       map[string]string `json:"annotations"`
}

type VulnerabilityReportReport struct {
	Artifact        VulnerabilityReportArtifact `json:"artifact"`
	Scanner         VulnerabilityReportScanner  `json:"scanner"`
	Vulnerabilities []Vulnerability             `json:"vulnerabilities"`
	UpdateTimestamp string                      `json:"updateTimestamp"`
}

type VulnerabilityReportArtifact struct {
	Digest     string `json:"digest"`
	Repository string `json:"repository"`
	Tag        string `json:"tag"`
}

type VulnerabilityReportScanner struct {
	Name    string `json:"name"`
	Vendor  string `json:"vendor"`
	Version string `json:"version"`
}

type Vulnerability struct {
	VulnerabilityID  string   `json:"vulnerabilityID"`
	Severity         string   `json:"severity"`
	Title            string   `json:"title"`
	Description      string   `json:"description"`
	Score            float64  `json:"score"`
	Resource         string   `json:"resource"`
	InstalledVersion string   `json:"installedVersion"`
	FixedVersion     string   `json:"fixedVersion"`
	PublishedDate    string   `json:"publishedDate"`
	LastModifiedDate string   `json:"lastModifiedDate"`
	PrimaryLink      string   `json:"primaryLink"`
	Links            []string `json:"links"`
	PackagePURL      string   `json:"packagePURL"`
	Target           string   `json:"target"`
}

func ParseVulnerabilityReportManifest(jsonBytes []byte) (*VulnerabilityReportManifest, error) {
	var manifest VulnerabilityReportManifest
	err := json.Unmarshal(jsonBytes, &manifest)
	if err != nil {
		return nil, err
	}
	return &manifest, nil
}
