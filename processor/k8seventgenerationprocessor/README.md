# K8s Event Generation Processor

<!-- distribution links hack -->
[verified]: https://github.com/solarwinds/solarwinds-otel-collector-releases#verified
[playground]: https://github.com/solarwinds/solarwinds-otel-collector-releases#playground
[k8s]: https://github.com/solarwinds/solarwinds-otel-collector-releases#k8s

<!-- status autogenerated section -->
| Status        |           |
| ------------- |-----------|
| Stability     | [development]: logs   |
| Distributions | [k8s], [playground], [verified] |
| Issues        | [![Open issues](https://img.shields.io/github/issues-search/solarwinds/solarwinds-otel-collector-contrib?query=is%3Aissue%20is%3Aopen%20label%3Aprocessor%2Fk8seventgeneration%20&label=open&color=orange&logo=opentelemetry)](https://github.com/solarwinds/solarwinds-otel-collector-contrib/issues?q=is%3Aopen+is%3Aissue+label%3Aprocessor%2Fk8seventgeneration) [![Closed issues](https://img.shields.io/github/issues-search/solarwinds/solarwinds-otel-collector-contrib?query=is%3Aissue%20is%3Aclosed%20label%3Aprocessor%2Fk8seventgeneration%20&label=closed&color=blue&logo=opentelemetry)](https://github.com/solarwinds/solarwinds-otel-collector-contrib/issues?q=is%3Aclosed+is%3Aissue+label%3Aprocessor%2Fk8seventgeneration) |

[development]: https://github.com/open-telemetry/opentelemetry-collector/blob/main/docs/component-stability.md#development
[k8s]: https://github.com/open-telemetry/opentelemetry-collector-releases/tree/main/distributions/otelcol-k8s
[playground]: 
[verified]: 
<!-- end autogenerated section -->

## Overview

The k8seventgenerationprocessor transforms Kubernetes resource manifests into OpenTelemetry entity state events. It processes log records containing Kubernetes manifests and generates structured entity data and relationship information for observability platforms.

The processor consumes Kubernetes manifests (as JSON in log record bodies) and produces two types of outputs:
- **Entity state events**: Structured logs representing Kubernetes entities (Containers, Container Images, Vulnerabilities) with their attributes and relationships
- **Service mappings**: IP-to-service name mappings derived from Endpoints and EndpointSlice resources

This processor is designed to work in Kubernetes environments where manifests are collected and forwarded as logs to the OpenTelemetry Collector.

## Configuration

The processor requires no configuration parameters. Simply include it in your pipeline:

```yaml
processors:
  k8seventgeneration:

service:
  pipelines:
    logs:
      receivers: [...]
      processors: [k8seventgeneration, ...]
      exporters: [...]
```

## Supported Kubernetes Resources

### Pod Manifests

Processes Pod manifests to extract container and image information.

**Input Example:**

```json
{
  "apiVersion": "v1",
  "kind": "Pod",
  "metadata": {
    "name": "my-app",
    "namespace": "default"
  },
  "spec": {
    "containers": [
      {
        "name": "app-container",
        "image": "nginx:1.21"
      }
    ]
  },
  "status": {
    "containerStatuses": [
      {
        "name": "app-container",
        "containerID": "containerd://abc123",
        "imageID": "sha256:def456",
        "state": {
          "running": {
            "startedAt": "2025-01-08T10:00:00Z"
          }
        }
      }
    ]
  }
}
```

**Generated Entities:**
- `KubernetesContainer` entity with pod/namespace/container name as telemetry mapping
- `KubernetesContainerImage` entity with image digest and name
- Relationship: `KubernetesResourceUsesImage` (Container → ContainerImage)

### Endpoints Manifests

Processes Endpoints resources to create service-to-IP mappings.

**Input Example:**

```json
{
  "apiVersion": "v1",
  "kind": "Endpoints",
  "metadata": {
    "name": "my-service",
    "namespace": "default"
  },
  "subsets": [
    {
      "addresses": [
        {"ip": "10.0.1.100"},
        {"ip": "10.0.1.101"}
      ],
      "ports": [
        {"name": "http", "port": 8080, "protocol": "TCP"}
      ]
    }
  ]
}
```

**Generated Output:**
- Service mapping logs with `k8s.service.name`, `k8s.namespace.name`, and `sw.k8s.workload.ip`

### EndpointSlice Manifests

Processes EndpointSlice resources (newer Endpoints API) for service mappings.

**Input Example:**

```json
{
  "apiVersion": "discovery.k8s.io/v1",
  "kind": "EndpointSlice",
  "metadata": {
    "name": "my-service-abc",
    "namespace": "default",
    "labels": {
      "kubernetes.io/service-name": "my-service"
    }
  },
  "endpoints": [
    {
      "addresses": ["10.0.1.100"],
      "conditions": {"ready": true}
    }
  ],
  "ports": [
    {"name": "http", "port": 8080, "protocol": "TCP"}
  ]
}
```

**Generated Output:**
- Service mapping logs similar to Endpoints

### VulnerabilityReport Manifests (Trivy Operator)

Processes VulnerabilityReport CRDs from Trivy Operator (aquasecurity.github.io/v1alpha1).

The processor implements a **two-entity, one-relationship model** for vulnerabilities:

1. **VulnerabilityDetail Entity**: Represents each CVE/vulnerability observed on a specific resource with a specific version
   - **Composite ID**: `vulnerability.id` + `resource` + `installedVersion` (uniquely identifies each finding)
   - **Merged properties**: resource, installedVersion, fixedVersion, vendorSeverity, scoreEnvironmental, scannerVendor, scannerName, scannerVersion
   - **Calculated severity**: severity is calculated from CVSS base score using standard ranges (CRITICAL ≥ 9.0, HIGH ≥ 7.0, MEDIUM ≥ 4.0, LOW > 0)
   - **Additional fields**: classification ("CVSS"), publishedDate, lastModifiedDate, CVSS vectors and scores

2. **KubernetesContainerImage Entity**: The scanned container image

3. **VulnerabilityFinding Relationship**: Links VulnerabilityDetail → KubernetesContainerImage with scanner metadata

**Input Example:**

```json
{
  "apiVersion": "aquasecurity.github.io/v1alpha1",
  "kind": "VulnerabilityReport",
  "metadata": {
    "name": "deployment-myapp-container",
    "namespace": "default",
    "labels": {
      "trivy-operator.resource.kind": "Deployment",
      "trivy-operator.resource.name": "myapp",
      "trivy-operator.container.name": "app"
    }
  },
  "report": {
    "registry": {
      "server": "docker.io"
    },
    "artifact": {
      "repository": "library/nginx",
      "tag": "1.21",
      "digest": "sha256:abc123def456"
    },
    "vulnerabilities": [
      {
        "vulnerabilityID": "CVE-2023-12345",
        "title": "Example vulnerability",
        "severity": "HIGH",
        "fixedVersion": "1.22",
        "installedVersion": "1.21",
        "primaryLink": "https://nvd.nist.gov/vuln/detail/CVE-2023-12345",
        "resource": "nginx",
        "score": 7.5,
        "cvss": {
          "nvd": {
            "V3Vector": "CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H",
            "V3Score": 7.5
          }
        }
      }
    ]
  }
}
```

**Generated Entities:**
- `VulnerabilityDetail` entity for each unique CVE-resource-version combination
  - Composite ID: `vulnerability.id` + `resource` + `installedVersion`
  - Attributes include: severity (calculated from CVSS base score), CVSS scores, resource, installedVersion, fixedVersion, vendorSeverity, classification, description, links
- `KubernetesContainerImage` entity for the scanned image
- Relationship:
  - `VulnerabilityFinding`: VulnerabilityDetail → KubernetesContainerImage
    - Includes scanner metadata: scannerVendor, scannerName, scannerVersion

## Output Format

### Entity State Events

Entity state events are emitted as log records with specific attributes:

```
Resource Attributes:
  - sw.k8s.log.type: "entitystateevent"

Scope Attributes:
  - otel.entity.event_as_log: true

Log Record Attributes:
  - otel.entity.event.type: "entity_state" (or "entity_relationship_state")
  - otel.entity.type: "KubernetesContainer" | "KubernetesContainerImage" | "VulnerabilityDetail"
  - otel.entity.id: Map of telemetry mapping attributes (pod name, namespace, container name, image digest, vulnerability ID, etc.)
  - otel.entity.attributes: Map of entity-specific attributes
```

**Example Container Entity Log Record:**

```json
{
  "observedTimestamp": "2025-01-08T10:00:00Z",
  "attributes": {
    "otel.entity.event.type": "entity_state",
    "otel.entity.type": "KubernetesContainer",
    "otel.entity.id": {
      "k8s.pod.name": "my-app",
      "k8s.namespace.name": "default",
      "k8s.container.name": "app-container",
      "sw.k8s.cluster.uid": "cluster-123"
    },
    "otel.entity.attributes": {
      "container.id": "containerd://abc123",
      "sw.k8s.container.status": "running",
      "sw.k8s.container.init": false,
      "sw.k8s.container.sidecar": false
    }
  }
}
```

**Example Relationship Log Record:**

```json
{
  "observedTimestamp": "2025-01-08T10:00:00Z",
  "attributes": {
    "otel.entity.event.type": "entity_relationship_state",
    "otel.entity_relationship.type": "KubernetesResourceUsesImage",
    "otel.entity_relationship.source_entity.type": "KubernetesContainer",
    "otel.entity_relationship.source_entity.id": {
      "k8s.pod.name": "my-app",
      "k8s.namespace.name": "default",
      "k8s.container.name": "app-container",
      "sw.k8s.cluster.uid": "cluster-123"
    },
    "otel.entity_relationship.destination_entity.type": "KubernetesContainerImage",
    "otel.entity_relationship.destination_entity.id": {
      "oci.manifest.digest": "sha256:def456",
      "container.image.name": "docker.io/library/nginx"
    },
    "otel.entity_relationship.attributes": {
      "image.tag": "1.21"
    }
  }
}
```

**Example VulnerabilityDetail Entity Log Record:**

```json
{
  "observedTimestamp": "2025-01-08T10:00:00Z",
  "attributes": {
    "otel.entity.event.type": "entity_state",
    "otel.entity.type": "VulnerabilityDetail",
    "otel.entity.id": {
      "vulnerability.id": "CVE-2023-12345",
      "resource": "nginx",
      "installedVersion": "1.21"
    },
    "otel.entity.attributes": {
      "vulnerability.severity": "HIGH",
      "vulnerability.score.base": 7.5,
      "vulnerability.classification": "CVSS",
      "vulnerability.description": "Example vulnerability",
      "vulnerability.links": ["https://nvd.nist.gov/vuln/detail/CVE-2023-12345"],
      "resource": "nginx",
      "installedVersion": "1.21",
      "fixedVersion": "1.22",
      "vendorSeverity": "HIGH",
      "scoreEnvironmental": 7.5,
      "scannerVendor": "Aqua Security",
      "scannerName": "Trivy",
      "scannerVersion": "0.50.0"
    }
  }
}
```

**Example VulnerabilityFinding Relationship Log Record:**

```json
{
  "observedTimestamp": "2025-01-08T10:00:00Z",
  "attributes": {
    "otel.entity.event.type": "entity_relationship_state",
    "otel.entity_relationship.type": "VulnerabilityFinding",
    "otel.entity_relationship.source_entity.type": "VulnerabilityDetail",
    "otel.entity_relationship.source_entity.id": {
      "vulnerability.id": "CVE-2023-12345",
      "resource": "nginx",
      "installedVersion": "1.21"
    },
    "otel.entity_relationship.destination_entity.type": "KubernetesContainerImage",
    "otel.entity_relationship.destination_entity.id": {
      "oci.manifest.digest": "sha256:abc123def456",
      "container.image.name": "docker.io/library/nginx"
    },
    "otel.entity_relationship.attributes": {
      "scannerVendor": "Aqua Security",
      "scannerName": "Trivy",
      "scannerVersion": "0.50.0"
    }
  }
}
```

### Service Mappings

Service mappings are emitted as separate log records:

```
Resource Attributes:
  - sw.k8s.log.type: "serviceendpointsmapping"

Log Record Attributes:
  - k8s.service.name: Service name
  - k8s.namespace.name: Namespace
  - sw.k8s.workload.ip: Pod IP address
  - sw.k8s.cluster.uid: Cluster UID
```

## Processing Flow

1. **Input Validation**: Processor examines each log record for `k8s.object.kind` attribute
2. **Manifest Parsing**: Parses the log body as JSON based on the detected kind (Pod, Endpoints, EndpointSlice, VulnerabilityReport)
3. **Entity Generation**: Transforms manifest data into entity state events with proper telemetry mappings and attributes
4. **Output Emission**: Appends generated entity state events and service mappings as new ResourceLogs to the pipeline

## Notes

- The processor does not modify existing log records; it only appends new ones
- Container images are deduplicated by digest and name (tags are stored as attributes)
- VulnerabilityReport processing requires `apiVersion: aquasecurity.github.io/v1alpha1`
- Vulnerability severity is calculated from CVSS base score using standard ranges (CRITICAL ≥ 9.0, HIGH ≥ 7.0, MEDIUM ≥ 4.0, LOW > 0)
- VulnerabilityDetail uses a composite ID (vulnerability.id + resource + installedVersion) to uniquely identify each finding
- Timestamps are derived from log record's ObservedTimestamp, Timestamp, or current time (in that order)
- All entity IDs use telemetry mapping semantics for correlation with metrics and traces
